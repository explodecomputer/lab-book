{
  "hash": "e1c11575903a0ea2a22ed5ad300e5dea",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Getting effect sizes from R/qtl2\"\nauthor: Gibran Hemani\ndate: \"2025-10-16\"\ncategories: [] \nhtml:\n    embed-resources: true\n---\n\n\n## Background\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(qtl2)\nlibrary(ggplot2)\nlibrary(dplyr)\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\n\nAttaching package: 'dplyr'\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nThe following objects are masked from 'package:stats':\n\n    filter, lag\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nThe following objects are masked from 'package:base':\n\n    intersect, setdiff, setequal, union\n```\n\n\n:::\n\n```{.r .cell-code}\nlibrary(tidyr)\n```\n:::\n\n\nDownload the data and read in\n\n\n::: {.cell}\n\n```{.r .cell-code}\nfile <- \"https://raw.githubusercontent.com/rqtl/qtl2data/main/DOex/DOex.zip\"\nDOex <- read_cross2(file)\n```\n:::\n\n\nCalculate genotype and allele probabilities\n\n\n::: {.cell}\n\n```{.r .cell-code}\npr <- calc_genoprob(DOex, error_prob=0.002)\napr <- genoprob_to_alleleprob(pr)\n```\n:::\n\n\nCalculate kinships\n\n\n::: {.cell}\n\n```{.r .cell-code}\nk <- calc_kinship(apr, \"loco\")\n```\n:::\n\n\nOrganise covariates\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsex <- (DOex$covar$Sex == \"male\")*1\nnames(sex) <- rownames(DOex$covar)\n\nsex <- setNames( (DOex$covar$Sex == \"male\")*1, rownames(DOex$covar) )\n```\n:::\n\n\nPerform scan\n\n\n::: {.cell}\n\n```{.r .cell-code}\nout <- scan1(apr, DOex$pheno, k, sex)\n\npar(mar=c(4.1, 4.1, 0.6, 0.6))\nplot(out, DOex$gmap)\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-6-1.png){width=672}\n:::\n:::\n\n\nGet coefficients for each marker on chromosome 2. This gives an additive effect for each founder line. \n\n\n::: {.cell}\n\n```{.r .cell-code}\ncoef_c2 <- scan1coef(apr[,\"2\"], DOex$pheno, k[[\"2\"]], sex, se=TRUE)\npar(mar=c(4.1, 4.1, 0.6, 0.6))\nplot_coefCC(coef_c2, DOex$gmap[\"2\"], bgcolor=\"gray95\", legend=\"bottomleft\")\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-7-1.png){width=672}\n:::\n:::\n\n\nWe can also get p-values for each founder line:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nz <- coef_c2 / attributes(coef_c2)$SE\npval <- pnorm(abs(z), low=F)\nplot_coefCC(-log10(pval), DOex$gmap[\"2\"], bgcolor=\"gray95\", legend=\"bottomleft\")\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-8-1.png){width=672}\n:::\n:::\n\n\n\nMake a forest plot of the effect sizes at the peak:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmarker_position <- which(abs(coef_c2[,1:8]) == max(abs(coef_c2[,1:8])), arr.ind=TRUE)[1]\nbest_coef <- tibble(\n    line = colnames(coef_c2)[1:8],\n    b=coef_c2[marker_position,1:8], \n    se = attributes(coef_c2)$SE[marker_position,1:8],\n    lci = b - 1.96 * se,\n    uci = b + 1.96 * se\n)\nggplot(best_coef, aes(x=b, y=line)) +\ngeom_point() +\ngeom_errorbarh(aes(xmin=lci, xmax=uci)) +\ngeom_vline(linetype=\"dotted\", xintercept=0)\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-9-1.png){width=672}\n:::\n:::\n\n\n\nThere is clear heterogeneity in effect sizes across the lines, so the average effect would be diluted. This heterogeneity could be because the marker is in LD with the causal variant in one line but not the others?\n\nTo what degree are these effects correlated at null positions?\n\n\n::: {.cell}\n\n```{.r .cell-code}\nnull_positions <- which(out < 2)\n\ncoefs <- lapply(names(apr), \\(x) {\n    scan1coef(apr[,x], DOex$pheno, k[[x]], sex, se=TRUE)\n})\n\ncoefs <- do.call(rbind, coefs)[null_positions,1:8]\ncor(coefs) %>% \n    as_tibble() %>% \n    mutate(line = LETTERS[1:8]) %>% \n    tidyr::pivot_longer(!line) %>%\n    ggplot(., aes(x=line, y=name)) +\n        geom_tile(aes(fill=value)) +\n        scale_fill_gradient2() +\n        geom_text(aes(label=round(value, 2)))\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-10-1.png){width=672}\n:::\n:::\n\n\nTry permuting for comparison\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncoefs_permuted <- coefs\n\nfor(i in 1:ncol(coefs_permuted)) {\n    coefs_permuted[,i] <- sample(coefs_permuted[,i])\n}\ncor(coefs_permuted) %>% \n    as_tibble() %>% \n    mutate(line = LETTERS[1:8]) %>% \n    tidyr::pivot_longer(!line) %>%\n    ggplot(., aes(x=line, y=name)) +\n        geom_tile(aes(fill=value)) +\n        scale_fill_gradient2() +\n        geom_text(aes(label=round(value, 2)))\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-11-1.png){width=672}\n:::\n:::\n\n\n\n\nQuestions\n\n- How would you obtain an average additive effect estimate across all lines?\n\n\n---\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsessionInfo()\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nR version 4.5.1 (2025-06-13)\nPlatform: aarch64-apple-darwin20\nRunning under: macOS Sonoma 14.6.1\n\nMatrix products: default\nBLAS:   /Library/Frameworks/R.framework/Versions/4.5-arm64/Resources/lib/libRblas.0.dylib \nLAPACK: /Library/Frameworks/R.framework/Versions/4.5-arm64/Resources/lib/libRlapack.dylib;  LAPACK version 3.12.1\n\nlocale:\n[1] en_US.UTF-8/en_US.UTF-8/en_US.UTF-8/C/en_US.UTF-8/en_US.UTF-8\n\ntime zone: Europe/London\ntzcode source: internal\n\nattached base packages:\n[1] stats     graphics  grDevices utils     datasets  methods   base     \n\nother attached packages:\n[1] tidyr_1.3.1   dplyr_1.1.4   ggplot2_3.5.2 qtl2_0.38    \n\nloaded via a namespace (and not attached):\n [1] bit_4.6.0          gtable_0.3.6       jsonlite_2.0.0     compiler_4.5.1    \n [5] tidyselect_1.2.1   Rcpp_1.1.0         blob_1.2.4         parallel_4.5.1    \n [9] scales_1.4.0       yaml_2.3.10        fastmap_1.2.0      R6_2.6.1          \n[13] labeling_0.4.3     generics_0.1.4     knitr_1.50         htmlwidgets_1.6.4 \n[17] tibble_3.3.0       DBI_1.2.3          pillar_1.11.0      RColorBrewer_1.1-3\n[21] rlang_1.1.6        cachem_1.1.0       xfun_0.52          bit64_4.6.0-1     \n[25] RSQLite_2.3.11     memoise_2.0.1      cli_3.6.5          withr_3.0.2       \n[29] magrittr_2.0.3     digest_0.6.37      grid_4.5.1         lifecycle_1.0.4   \n[33] vctrs_0.6.5        evaluate_1.0.4     glue_1.8.0         data.table_1.17.8 \n[37] farver_2.1.2       rmarkdown_2.29     purrr_1.1.0        tools_4.5.1       \n[41] pkgconfig_2.0.3    htmltools_0.5.8.1 \n```\n\n\n:::\n:::\n",
    "supporting": [
      "index_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}