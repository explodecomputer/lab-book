{
  "hash": "a34890f7f0f447443bd43b55c0dae968",
  "result": {
    "markdown": "---\ntitle: \"Sibling replication of Backman rare variants\"\nauthor: Gibran Hemani\ndate: \"2022-12-14\"\ncategories: [rare variants, genetics, family studies]\n---\n\n\n## Objective\n\nBackman et al 2022 (https://www.nature.com/articles/s41586-021-04103-z) performed exome GWAS of 4k traits, and found 564 rare-variant - trait pairs. They corrected for 20 PCs from common variants and 20 PCs from rare variants.\n\nQuestion: Is uncontrolled recent population stratification biasing these associations or even driving false positives?\n\nWe could use siblings to estimate the direct effects for these discovery associations. There would be two major hits to power, first only 20k of the 500k UK Biobank will be used. Second, power to detect direct effects using siblings is reduced. So we can't conclude that these are false positives if they simply don't replicate in the sibling analysis.\n\nInstead, we can ask to what extent are the replication associations consistent with the original estimates, given the reduction in precision. i.e. What fraction are expected to replicate at some nominal threshold, and what fraction are observed to replicate. If there is a significant difference between the observed and expected replication rate, then that indicates uncorrected inflation in the discovery exome GWAS.\n\nThis analysis: Power calculation - how much shrinkage would there need to be before there is 80% power to detect a difference between the sibling estimate and the population estimate?\n\nRead in Backman results\n\nThere were 564 rare-variant - trait pairs in Backman et al 2022. Of these 484 were for quantitative traits, restricting to those here for simplicity.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(here)\n```\n\n::: {.cell-output .cell-output-stderr}\n```\nhere() starts at /Users/gh13047/repo/lab-book\n```\n:::\n\n```{.r .cell-code}\nlibrary(dplyr)\n```\n\n::: {.cell-output .cell-output-stderr}\n```\n\nAttaching package: 'dplyr'\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\nThe following objects are masked from 'package:stats':\n\n    filter, lag\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\nThe following objects are masked from 'package:base':\n\n    intersect, setdiff, setequal, union\n```\n:::\n\n```{.r .cell-code}\nlibrary(ggplot2)\nset.seed(12345)\ndat <- read.csv(\"Book3.csv\", stringsAsFactors=FALSE, header=TRUE) %>% \n  as_tibble() %>%\n  mutate(se = (uci - beta)/1.96)\ndat %>% glimpse()\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nRows: 484\nColumns: 14\n$ Effect..95..CI.                               <chr> \"-0.15 (-0.19, -0.11)\", …\n$ P.value                                       <dbl> 9.25e-12, 1.24e-24, 1.03…\n$ Effect.direction                              <chr> \"-\", \"-\", \"-\", \"+\", \"-\",…\n$ N.cases.with.0.1.2.copies.of.effect.allele    <chr> \"88038|1684|13\", \"418277…\n$ N.controls.with.0.1.2.copies.of.effect.allele <chr> \"NA|NA|NA\", \"NA|NA|NA\", …\n$ Effect.allele.frequency                       <dbl> 9.5e-03, 2.1e-04, 4.9e-0…\n$ AA                                            <int> 88038, 418277, 407938, 3…\n$ AB                                            <int> 1684, 177, 4027, 4076, 1…\n$ BB                                            <int> 13, 0, 11, 1, 8, 0, 1, 0…\n$ N                                             <int> 89735, 418454, 411976, 3…\n$ beta                                          <dbl> -0.150, -0.720, -0.100, …\n$ lci                                           <chr> \"-0.19\", \"-0.86\", \"-0.13…\n$ uci                                           <dbl> -0.110, -0.580, -0.079, …\n$ se                                            <dbl> 0.020408163, 0.071428571…\n```\n:::\n\n```{.r .cell-code}\nplot(-log10(dat$P.value), abs(dat$beta)/dat$se)\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-1-1.png){width=672}\n:::\n:::\n\n\nFunctions from Alex for relative sample size between designs:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nunrel_vs_sib = function(h2){\n  return(1+h2*(1-h2)/(4-h2))\n}\n\nunrel_vs_sib_inv = function(h2){\n  return((1+h2*(1-h2)/(4-h2))^(-1))\n}\n\nunrel_vs_trio = function(h2){\n  return(1+h2*(1-h2)/(3-h2*(1+h2/2)))\n}\n\nunrel_vs_trio_inv = function(h2){\n  return((1+h2*(1-h2)/(3-h2*(1+h2/2)))^(-1))\n}\n\nunrel_vs_direct_trio = function(h2){return(0.5/3)}\nunrel_vs_direct_sibdiff = function(h2){return((2*(2-h2))^(-1))}\nunrel_vs_direct_sibimp = function(h2){return((2+h2/2)/(6*(1-(h2/2)^2)))}\n```\n:::\n\n\nFunction to estimate expected replication rate\n\n\n::: {.cell}\n\n```{.r .cell-code}\nprop_overlap <- function(b_disc, b_rep, se_disc, se_rep, alpha)\n{\n  p_sign <- pnorm(-abs(b_disc) / se_disc) * pnorm(-abs(b_disc) / se_rep) + ((1 - pnorm(-abs(b_disc) / se_disc)) * (1 - pnorm(-abs(b_disc) / se_rep)))\n  p_sig <- pnorm(-abs(b_disc) / se_rep + qnorm(alpha / 2)) + (1 - pnorm(-abs(b_disc) / se_rep - qnorm(alpha / 2)))\n  p_rep <- pnorm(abs(b_rep)/se_rep, lower.tail=FALSE)\n  res <- tibble::tibble(\n    nsnp=length(b_disc),\n    metric=c(\"Sign\", \"Sign\", \"P-value\", \"P-value\"),\n    datum=c(\"Expected\", \"Observed\", \"Expected\", \"Observed\"),\n    value=c(sum(p_sign, na.rm=TRUE), sum(sign(b_disc) == sign(b_rep)), sum(p_sig, na.rm=TRUE), sum(p_rep < alpha, na.rm=TRUE))\n  )\n  pdif <- list(\n    Sign = binom.test(res$value[2], res$nsnp[1], res$value[1] / res$nsnp[1])$p.value,\n    `P-value` = binom.test(res$value[4], res$nsnp[1], res$value[3] / res$nsnp[1])$p.value\n  ) %>% as_tibble()\n  return(list(res=res, pdif=pdif, variants=dplyr::tibble(sig=p_sig, sign=p_sign)))\n}\n```\n:::\n\n\nFunction to simulate assocs in siblings\n\n\n::: {.cell}\n\n```{.r .cell-code}\nexpected_se <- function (beta, af, n, vy) \n{\n    sqrt(c(vy) - beta^2 * 2 * af * (1 - af))/sqrt(n) * (1/sqrt(2 * \n        af * (1 - af)))\n}\n\nexpected_vy <- function(beta, af, n, se)\n{\n  se^2 * 2 * af * (1 - af)*n + beta^2 * 2 * af * (1 - af)\n}\n\n# check algebra!\n# expected_se(0.2, 0.4, 1000, 10)\n# expected_vy(0.2, 0.4, 1000, expected_se(0.2, 0.4, 1000, 10))\n\nsimgwas_sib <- function(beta_disc, se_disc, af_disc, n_disc, prop_sibs, h2, alpha, shrinkage)\n{\n  d <- tibble(\n    beta_disc = beta_disc,\n    beta_true = beta_disc * shrinkage,\n    vy = expected_vy(beta_disc, af_disc, n_disc, se_disc),\n    n_rep = n_disc * prop_sibs * unrel_vs_direct_sibimp(h2),\n    se_rep = expected_se(beta_disc, af_disc, n_rep, vy),\n    beta_rep = rnorm(length(beta_disc), beta_true, se_rep)\n  ) \n  d %>%\n    {prop_overlap(.$beta_disc, .$beta_rep, se_disc, .$se_rep, alpha)}\n}\n```\n:::\n\n\nPower analysis\n\n\n::: {.cell}\n\n```{.r .cell-code}\nparams <- expand.grid(sim=1:500, shrinkage=seq(0,1,0.05))\nres <- lapply(1:nrow(params), function(i) \n  simgwas_sib(dat$beta, dat$se, dat$Effect.allele.frequency, dat$N, 20000/500000,0.5, 0.05/nrow(dat), params$shrinkage[i])\n  ) %>%\n  lapply(., function(x) x$pdif) %>% bind_rows() %>% bind_cols(., params)\nres\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# A tibble: 10,500 × 4\n        Sign `P-value`   sim shrinkage\n       <dbl>     <dbl> <int>     <dbl>\n 1 1.04e- 91  2.33e-11     1         0\n 2 3.19e- 95  2.33e-11     2         0\n 3 7.72e- 91  2.33e-11     3         0\n 4 4.13e- 89  2.33e-11     4         0\n 5 3.52e-105  2.33e-11     5         0\n 6 6.78e- 98  2.33e-11     6         0\n 7 1.85e- 93  2.33e-11     7         0\n 8 4.14e- 96  2.33e-11     8         0\n 9 1.76e-118  9.03e-10     9         0\n10 9.63e-112  2.33e-11    10         0\n# … with 10,490 more rows\n```\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nres %>% \n  group_by(shrinkage) %>%\n  summarise(Sign=sum(Sign < 0.05)/n(), `P-value`=sum(`P-value` < 0.05)/n()) %>%\n  tidyr::gather(key=\"key\", value=\"value\", c(`Sign`, `P-value`)) %>%\n  ggplot(., aes(x=shrinkage, y=value)) +\n    geom_point(aes(colour=key)) +\n    geom_line(aes(colour=key)) +\n    labs(x=\"Shrinkage of effect size, or 1-FDR\", y=\"Power to detect difference from expectation\")\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-6-1.png){width=672}\n:::\n:::\n\n\n\n## Summary\n\nPower is quite high to detect a difference!\n\n---\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsessionInfo()\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nR version 4.2.1 Patched (2022-09-06 r82817)\nPlatform: aarch64-apple-darwin20 (64-bit)\nRunning under: macOS Monterey 12.6.2\n\nMatrix products: default\nBLAS:   /Library/Frameworks/R.framework/Versions/4.2-arm64/Resources/lib/libRblas.0.dylib\nLAPACK: /Library/Frameworks/R.framework/Versions/4.2-arm64/Resources/lib/libRlapack.dylib\n\nlocale:\n[1] en_GB.UTF-8/en_GB.UTF-8/en_GB.UTF-8/C/en_GB.UTF-8/en_GB.UTF-8\n\nattached base packages:\n[1] stats     graphics  grDevices utils     datasets  methods   base     \n\nother attached packages:\n[1] ggplot2_3.4.0 dplyr_1.0.10  here_1.0.1   \n\nloaded via a namespace (and not attached):\n [1] pillar_1.8.1      compiler_4.2.1    tools_4.2.1       digest_0.6.31    \n [5] jsonlite_1.8.4    evaluate_0.19     lifecycle_1.0.3   tibble_3.1.8     \n [9] gtable_0.3.1      pkgconfig_2.0.3   rlang_1.0.6       cli_3.5.0        \n[13] DBI_1.1.3         yaml_2.3.6        xfun_0.36         fastmap_1.1.0    \n[17] withr_2.5.0       stringr_1.5.0     knitr_1.41        generics_0.1.3   \n[21] vctrs_0.5.1       htmlwidgets_1.5.4 rprojroot_2.0.3   grid_4.2.1       \n[25] tidyselect_1.2.0  glue_1.6.2        R6_2.5.1          fansi_1.0.3      \n[29] rmarkdown_2.16    farver_2.1.1      tidyr_1.2.1       purrr_1.0.0      \n[33] magrittr_2.0.3    ellipsis_0.3.2    scales_1.2.1      htmltools_0.5.4  \n[37] assertthat_0.2.1  colorspace_2.0-3  labeling_0.4.2    utf8_1.2.2       \n[41] stringi_1.7.8     munsell_0.5.0    \n```\n:::\n:::\n",
    "supporting": [
      "index_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}