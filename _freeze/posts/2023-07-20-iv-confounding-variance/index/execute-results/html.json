{
  "hash": "8e2e33f8ab82a761e3571d897ae2c26f",
  "result": {
    "markdown": "---\ntitle: \"IV confounding with changing variances\"\nauthor: Gibran Hemani\ndate: \"2023-07-20\"\ncategories: []\n---\n\n\n## Background\n\nWhen instruments arise through U the bias is buy/bux, whereas ols bias is buy*bux. If buy is larger than bux then the iv bias will be smaller than ols bias, but otherwise likely to be larger than ols bias.\n\nWhat happens if you just rescale the values of x and y?\n\n\nbias_ols = buy * bux\n\nWhen the SNP goes through U\nbias_iv = buy/bux\n\n\nbuy = 0.1\nbux = 0.1\n\nbias_iv = 1\nbias_ols = 0.01\n\n---\n\nchange sd of y and x to be from 1 to 10\n\nbuy = 1\nbux = 1\n\nbias_iv = 1\nbias_ols = 1\n\n---\n\nbuy = 0.1\nbux = 1\n\nbias_iv = 0.1\nbias_ols = 0.1\n\n\ny = buy * u + e\nx = bux * u + e\n\nb_ols = cov(buy*u, bux*u)\n= buy * bux * var(u)\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(ggplot2)\nlibrary(tidyr)\nlibrary(dplyr)\n```\n\n::: {.cell-output .cell-output-stderr}\n```\n\nAttaching package: 'dplyr'\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\nThe following objects are masked from 'package:stats':\n\n    filter, lag\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\nThe following objects are masked from 'package:base':\n\n    intersect, setdiff, setequal, union\n```\n:::\n\n```{.r .cell-code}\nlibrary(TwoSampleMR)\n```\n\n::: {.cell-output .cell-output-stderr}\n```\nTwoSampleMR version 0.5.7 \n[>] New: Option to use non-European LD reference panels for clumping etc\n[>] Some studies temporarily quarantined to verify effect allele\n[>] See news(package='TwoSampleMR') and https://gwas.mrcieu.ac.uk for further details\n```\n:::\n\n```{.r .cell-code}\nlibrary(simulateGP)\n```\n\n::: {.cell-output .cell-output-stderr}\n```\n\nAttaching package: 'simulateGP'\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\nThe following objects are masked from 'package:TwoSampleMR':\n\n    allele_frequency, contingency, get_population_allele_frequency\n```\n:::\n\n```{.r .cell-code}\niv_bias <- function(g, x, y) {\n    bgx = cov(g, x) / var(g)\n    bgy = cov(g, y) / var(g)\n    return(bgy/bgx)\n}\n\nols_bias <- function(x, y) {\n    return(cov(x,y)/var(x))\n}\n\nn <- 100000\ng <- rbinom(n, 2, 0.4)\nu <- g + rnorm(n, 0, sqrt(1 - var(g)))\n\nbux <- 0.5\nbuy <- 0.5\ny <- u * buy + rnorm(n, sd=sqrt(1-buy^2))\nx <- u * bux + rnorm(n, sd=sqrt(1-bux^2))\n\n\niv_bias(g, x, y)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n[1] 0.9936364\n```\n:::\n\n```{.r .cell-code}\nols_bias(x,y)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n[1] 0.2451663\n```\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nparam1 <- expand.grid(\n    bux=seq(-1, 1, by=0.1),\n    buy=seq(-1, 1, by=0.1)\n)\n\nfor(i in 1:nrow(param1)) {\n    y <- u * param1$buy[i] + rnorm(n, sd=sqrt(1-param1$buy[i]^2))\n    x <- u * param1$bux[i] + rnorm(n, sd=sqrt(1-param1$bux[i]^2))\n    param1$ols_bias[i] <- ols_bias(x, y)\n    param1$iv_bias[i] <- iv_bias(g, x, y)\n    param1$ols_bias_e[i] <- param1$buy[i] * param1$bux[i]\n    param1$iv_bias_e[i] <- param1$buy[i] / param1$bux[i]\n}\n\nparam1 %>% filter(bux != 0) %>%\ngather(key=\"key\", value=\"value\", c(ols_bias, iv_bias)) %>% \nggplot(., aes(x=bux, y=value)) +\ngeom_point(aes(colour=key)) +\nfacet_wrap(~ buy)\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-2-1.png){width=672}\n:::\n:::\n\n\nIs expected bias correct\n\n\n::: {.cell}\n\n```{.r .cell-code}\nplot(ols_bias ~ ols_bias_e, param1)\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-3-1.png){width=672}\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nplot(iv_bias ~ iv_bias_e, param1 %>% filter(bux!=0))\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-4-1.png){width=672}\n:::\n:::\n\n\nnow change the variances\n\n\n::: {.cell}\n\n```{.r .cell-code}\nparam2 <- expand.grid(\n    bux=seq(-1, 1, by=0.1),\n    buy=0.5,\n    varx=c(1, 0.1, 10),\n    vary=c(1, 0.1, 10)\n)\n\nfor(i in 1:nrow(param2)) {\n    y <- u * param2$buy[i] + rnorm(n, sd=sqrt(1-param2$buy[i]^2))\n    x <- u * param2$bux[i] + rnorm(n, sd=sqrt(1-param2$bux[i]^2))\n    y <- y * sqrt(param2$vary[i])\n    x <- x * sqrt(param2$varx[i])\n    param2$ols_bias[i] <- ols_bias(x, y)\n    param2$iv_bias[i] <- iv_bias(g, x, y)\n    param2$ols_bias_e[i] <- param2$buy[i] * param2$bux[i]\n    param2$iv_bias_e[i] <- param2$buy[i] / param2$bux[i]\n}\n\nparam2 <- param2 %>% filter(bux != 0)\nparam2 <- bind_rows(\n    param2 %>% select(-c(ols_bias_e, iv_bias_e)) %>% gather(key=\"key\", value=\"value\", c(ols_bias, iv_bias)) %>% mutate(what=\"obs\"),\n    param2 %>% select(-c(ols_bias, iv_bias)) %>% gather(key=\"key\", value=\"value\", c(ols_bias_e, iv_bias_e)) %>% mutate(what=\"exp\") \n)\nggplot(param2, aes(x=bux, y=value)) +\ngeom_point(aes(colour=key)) +\nfacet_grid(varx ~ vary, labeller=label_both, scale=\"free_y\")\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-5-1.png){width=672}\n:::\n:::\n\n\nchange the variance only, see if it changes test statistic\n\n\n::: {.cell}\n\n```{.r .cell-code}\nparam3 <- expand.grid(\n    bux=seq(-1, 1, by=0.25),\n    buy=seq(-1, 1, by=0.25),\n    varx=c(0.1, 1, 10),\n    vary=c(0.1, 1, 10)\n) %>% mutate(sim=1:n())\n\nparam3 <- lapply(1:nrow(param3), function(i) {\n    y <- u * param2$buy[i] + rnorm(n, sd=sqrt(1-param2$buy[i]^2))\n    x <- u * param2$bux[i] + rnorm(n, sd=sqrt(1-param2$bux[i]^2))\n    y <- y * sqrt(param2$vary[i])\n    x <- x * sqrt(param2$varx[i])\n    get_effs(x, y, as.matrix(g)) %>% mr %>% suppressMessages %>% mutate(sim=i)\n}) %>% bind_rows() %>% inner_join(., param3, by=\"sim\")\n```\n\n::: {.cell-output .cell-output-stderr}\n```\nWarning in rnorm(n, sd = sqrt(1 - param2$buy[i]^2)): NAs produced\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\nWarning in rnorm(n, sd = sqrt(1 - param2$bux[i]^2)): NAs produced\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\nWarning in rnorm(n, sd = sqrt(1 - param2$buy[i]^2)): NAs produced\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\nWarning in rnorm(n, sd = sqrt(1 - param2$bux[i]^2)): NAs produced\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\nWarning in rnorm(n, sd = sqrt(1 - param2$buy[i]^2)): NAs produced\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\nWarning in rnorm(n, sd = sqrt(1 - param2$bux[i]^2)): NAs produced\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\nWarning in rnorm(n, sd = sqrt(1 - param2$buy[i]^2)): NAs produced\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\nWarning in rnorm(n, sd = sqrt(1 - param2$bux[i]^2)): NAs produced\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\nWarning in rnorm(n, sd = sqrt(1 - param2$buy[i]^2)): NAs produced\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\nWarning in rnorm(n, sd = sqrt(1 - param2$bux[i]^2)): NAs produced\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\nWarning in rnorm(n, sd = sqrt(1 - param2$buy[i]^2)): NAs produced\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\nWarning in rnorm(n, sd = sqrt(1 - param2$bux[i]^2)): NAs produced\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\nWarning in rnorm(n, sd = sqrt(1 - param2$buy[i]^2)): NAs produced\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\nWarning in rnorm(n, sd = sqrt(1 - param2$bux[i]^2)): NAs produced\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\nWarning in rnorm(n, sd = sqrt(1 - param2$buy[i]^2)): NAs produced\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\nWarning in rnorm(n, sd = sqrt(1 - param2$bux[i]^2)): NAs produced\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\nWarning in rnorm(n, sd = sqrt(1 - param2$buy[i]^2)): NAs produced\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\nWarning in rnorm(n, sd = sqrt(1 - param2$bux[i]^2)): NAs produced\n```\n:::\n\n```{.r .cell-code}\nparam3$tval <- param3$b/param3$se\n\nparam3 %>% group_by(bux, buy) %>%\n    summarise(m=mean(tval), s=sd(tval))\n```\n\n::: {.cell-output .cell-output-stderr}\n```\n`summarise()` has grouped output by 'bux'. You can override using the `.groups`\nargument.\n```\n:::\n\n::: {.cell-output .cell-output-stdout}\n```\n# A tibble: 81 × 4\n# Groups:   bux [9]\n     bux   buy      m       s\n   <dbl> <dbl>  <dbl>   <dbl>\n 1 -1    -1    -118.    1.11 \n 2 -1    -0.75   91.3  78.5  \n 3 -1    -0.5   -65.1 104.   \n 4 -1    -0.25   39.0 118.   \n 5 -1     0     -13.5 124.   \n 6 -1     0.25  -12.8 124.   \n 7 -1     0.5    39.1 117.   \n 8 -1     0.75  -65.3 103.   \n 9 -1     1     118.    1.11 \n10 -0.75 -1    -118.    0.826\n# ℹ 71 more rows\n```\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nparam3 %>% ggplot(., aes(x=as.factor(bux), y=abs(tval))) +\ngeom_point(aes(colour=as.factor(varx), shape=as.factor(vary))) +\nfacet_wrap(~ buy)\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-7-1.png){width=672}\n:::\n:::\n\n\n\n---\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsessionInfo()\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nR version 4.3.0 (2023-04-21)\nPlatform: aarch64-apple-darwin20 (64-bit)\nRunning under: macOS Monterey 12.6.8\n\nMatrix products: default\nBLAS:   /Library/Frameworks/R.framework/Versions/4.3-arm64/Resources/lib/libRblas.0.dylib \nLAPACK: /Library/Frameworks/R.framework/Versions/4.3-arm64/Resources/lib/libRlapack.dylib;  LAPACK version 3.11.0\n\nlocale:\n[1] en_US.UTF-8/en_US.UTF-8/en_US.UTF-8/C/en_US.UTF-8/en_US.UTF-8\n\ntime zone: Europe/London\ntzcode source: internal\n\nattached base packages:\n[1] stats     graphics  grDevices utils     datasets  methods   base     \n\nother attached packages:\n[1] simulateGP_0.1.2  TwoSampleMR_0.5.7 dplyr_1.1.2       tidyr_1.3.0      \n[5] ggplot2_3.4.2    \n\nloaded via a namespace (and not attached):\n [1] vctrs_0.6.2       cli_3.6.1         knitr_1.43        rlang_1.1.1      \n [5] xfun_0.39         purrr_1.0.1       generics_0.1.3    jsonlite_1.8.5   \n [9] labeling_0.4.2    glue_1.6.2        colorspace_2.1-0  plyr_1.8.8       \n[13] htmltools_0.5.5   scales_1.2.1      fansi_1.0.4       rmarkdown_2.22   \n[17] grid_4.3.0        evaluate_0.21     munsell_0.5.0     tibble_3.2.1     \n[21] fastmap_1.1.1     yaml_2.3.7        lifecycle_1.0.3   compiler_4.3.0   \n[25] Rcpp_1.0.10       htmlwidgets_1.6.2 pkgconfig_2.0.3   rstudioapi_0.14  \n[29] farver_2.1.1      digest_0.6.31     R6_2.5.1          tidyselect_1.2.0 \n[33] utf8_1.2.3        pillar_1.9.0      magrittr_2.0.3    withr_2.5.0      \n[37] tools_4.3.0       gtable_0.3.3     \n```\n:::\n:::\n",
    "supporting": [
      "index_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}