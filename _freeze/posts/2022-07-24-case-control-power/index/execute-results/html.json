{
  "hash": "d174a8016f7f4c0be817538ae54cfca3",
  "result": {
    "markdown": "---\ntitle: \"Power of GWAS in ascertained case control datasets\"\nauthor: \"Gibran Hemani\"\ndate: \"2022-07-24\"\n---\n\n\nCase control studies ascertain a fixed number of cases and controls. This changes the distribution of genetic liability in the selected sample - e.g. if the prevalence is low then the liability will be a truncated distribution for cases ascertained for the tail of the distribution, and truncated for the controls ascertained for a depletion of values in the tail (e.g. see here for illustrations https://pubmed.ncbi.nlm.nih.gov/21376301/). \n\nThe more rare the disease, the larger the variance of the liability when cases and controls are matched. This should improve statistical power because the cases and controls are ascertained to be more genetically distinct from each other.\n\nHowever, the Genetic Power Calculator concludes the opposite, as prevalence gets lower the power goes down (https://zzz.bwh.harvard.edu/gpc/cc2.html). e.g. for OR=1.1, ncase=1000, ncontrol=1000, af=0.5, for 80% power:\n\n- prev = 0.001, power = 4e-5\n- prev = 0.4, power = 0.71\n\nQuick simulation to investigate:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(simulateGP)\nlibrary(dplyr)\n```\n\n::: {.cell-output .cell-output-stderr}\n```\n\nAttaching package: 'dplyr'\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\nThe following objects are masked from 'package:stats':\n\n    filter, lag\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\nThe following objects are masked from 'package:base':\n\n    intersect, setdiff, setequal, union\n```\n:::\n\n```{.r .cell-code}\nlibrary(ggplot2)\n```\n:::\n\n\nGenerate a function that will \n\n1. create a population with some genetic liability\n2. stochastically assign disease status based on heritability and prevalence\n3. ascertain cases and controls\n4. identify how many significant associations in the case/control sample \n\n\n::: {.cell}\n\n```{.r .cell-code}\nsims <- function(ncase, ncontrol, nsnp, prev, hsq=0.5, thresh=5e-8)\n{\n  # Determine minimum sample size required to ascertain required number of cases and controls\n  n_req <- round(max(ncase / prev, ncontrol / prev) + 10000)\n  \n  # Generate matrix of genotype values\n  g <- make_geno(n_req, nsnp, 0.5)\n  \n  # Effect sizes for each SNP\n  b <- rnorm(nsnp)\n\n  dat <- tibble(\n    id = 1:n_req,\n    l = scale(g %*% b),               # genetic liability\n    p = gx_to_gp(l, hsq, prev),       # convert to disease probability\n    d = rbinom(n_req, 1, p)           # sample disease status from probability\n  )\n  \n  # Ascertain cases and controls \n  dat <- rbind(\n    subset(dat, d == 0)[1:ncase,],\n    subset(dat, d == 1)[1:ncontrol,]\n  )\n\n  # Perform GWAS\n  res <- gwas(dat$d, g[dat$id,], logistic=TRUE)\n  \n  # Count number of significant assocs\n  return(sum(res$pval < thresh))\n}\n```\n:::\n\n\nRun a bunch of simulations\n\n\n::: {.cell}\n\n```{.r .cell-code}\nparams <- expand.grid(\n  ncase = 1000,\n  ncontrol = 1000, \n  nsnp = c(2, 10, 100),\n  repeats = 1:10,\n  prev = seq(0.01, 0.3, by=0.01),\n  hsq=0.5,\n  thresh=5e-8\n) %>% select(-repeats)\nparams$nsig <- sapply(1:nrow(params), function(i) do.call(sims, params[i,]))\n```\n:::\n\n\nPlot\n\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot(params, aes(x=prev, y=nsig/nsnp)) +\n  geom_point() +\n  facet_grid(nsnp ~ ., labeller=label_both, scale=\"free_y\") +\n  geom_smooth()\n```\n\n::: {.cell-output .cell-output-stderr}\n```\n`geom_smooth()` using method = 'loess' and formula = 'y ~ x'\n```\n:::\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-4-1.png){width=672}\n:::\n:::\n\n\nSo power increases when prevalence is lower. Maybe this is related to polygenicity.\n\nSo what's GPC doing differently to get the opposite result (lower prev = lower power)?\n\n\n",
    "supporting": [
      "index_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}