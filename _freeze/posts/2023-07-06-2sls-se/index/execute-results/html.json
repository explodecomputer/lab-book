{
  "hash": "f91b08a5723c9b3ef6bfba7fdea4c900",
  "result": {
    "markdown": "---\ntitle: \"Standard error in two-stage least squares\"\nauthor: Gibran Hemani\ndate: \"2023-07-06\"\ncategories: [statistics]\n---\n\n\n## Background\n\nHow to calculate the 2sls SE that is returned by e.g. ivreg\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(ivreg)\nlibrary(dplyr)\n```\n\n::: {.cell-output .cell-output-stderr}\n```\n\nAttaching package: 'dplyr'\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\nThe following objects are masked from 'package:stats':\n\n    filter, lag\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\nThe following objects are masked from 'package:base':\n\n    intersect, setdiff, setequal, union\n```\n:::\n\n```{.r .cell-code}\nset.seed(1234)\n\n# Simulate\nn <- 1000\nz <- matrix(rnorm(n*2), n)\nu <- rnorm(n)\nx <-  z %*% c(0.1, 0.2) + rnorm(n) + u\ny <- u + x * 0.3 + rnorm(n)\n\nd <- tibble(z[,1], z[,2], x, y)\nnames(d) <- c(\"z1\", \"z2\", \"x\", \"y\")\nhead(d)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# A tibble: 6 Ã— 4\n      z1     z2    x[,1]  y[,1]\n   <dbl>  <dbl>    <dbl>  <dbl>\n1 -1.21  -1.21  -1.72    -2.45 \n2  0.277  0.301  0.502   -0.763\n3  1.08  -1.54  -0.00212 -0.306\n4 -2.35   0.635  2.92     3.99 \n5  0.429  0.703  0.121   -0.918\n6  0.506 -1.91  -1.73    -0.595\n```\n:::\n:::\n\n\nEstimate with ivreg\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsummary(ivreg(y ~ x | z1 + z2, data=d))\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n\nCall:\nivreg(formula = y ~ x | z1 + z2, data = d)\n\nResiduals:\n     Min       1Q   Median       3Q      Max \n-4.77224 -0.95740 -0.02718  1.02122  4.52467 \n\nCoefficients:\n             Estimate Std. Error t value Pr(>|t|)\n(Intercept) -0.008573   0.047024  -0.182    0.855\nx            0.223361   0.231282   0.966    0.334\n\nDiagnostic tests:\n                 df1 df2 statistic  p-value    \nWeak instruments   2 997    10.249 3.93e-05 ***\nWu-Hausman         1 997    10.298  0.00137 ** \nSargan             1  NA     0.114  0.73617    \n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\nResidual standard error: 1.48 on 998 degrees of freedom\nMultiple R-Squared: 0.2276,\tAdjusted R-squared: 0.2268 \nWald test: 0.9327 on 1 and 998 DF,  p-value: 0.3344 \n```\n:::\n:::\n\n\nManual estimation based on https://stats.stackexchange.com/questions/265780/calculation-of-iv-standard-errors-using-r\n\n\n::: {.cell}\n\n```{.r .cell-code}\nPz <- z %*% solve(t(z) %*% z) %*% t(z)\nbhat <- solve(t(x) %*% Pz %*% x) %*% t(x) %*% Pz %*% y\nomega <- diag(n) * drop(var(y))\nv <- solve(t(x) %*% Pz %*% x) %*% t(x) %*% Pz %*% omega %*% Pz %*% x %*% solve(t(x) %*% Pz %*% x)\n```\n:::\n\n\nResult\n\n\n::: {.cell}\n\n```{.r .cell-code}\nbhat\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n          [,1]\n[1,] 0.2237422\n```\n:::\n\n```{.r .cell-code}\nsqrt(v)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n          [,1]\n[1,] 0.2631128\n```\n:::\n:::\n\n\nbhat matches, standard error seems off\n\nAlternatively try a more standard approach - https://stats.stackexchange.com/questions/472144/how-to-manually-calculate-standard-errors-for-instrumental-variables\n\n\n::: {.cell}\n\n```{.r .cell-code}\nxhat <- z %*% solve(t(z) %*% z) %*% t(z) %*% x\nbhat <- solve(t(xhat) %*% xhat) %*% t(xhat) %*% y\ne <- y - x %*% bhat\nC <- sum(e^2) / n * solve(t(xhat) %*% xhat)\n```\n:::\n\n\nResult\n\n\n::: {.cell}\n\n```{.r .cell-code}\nbhat\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n          [,1]\n[1,] 0.2237422\n```\n:::\n\n```{.r .cell-code}\nsqrt(C)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n          [,1]\n[1,] 0.2310808\n```\n:::\n:::\n\n\nThis matches ivreg more closely\n\n---\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsessionInfo()\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nR version 4.3.0 (2023-04-21)\nPlatform: aarch64-apple-darwin20 (64-bit)\nRunning under: macOS Monterey 12.6.2\n\nMatrix products: default\nBLAS:   /Library/Frameworks/R.framework/Versions/4.3-arm64/Resources/lib/libRblas.0.dylib \nLAPACK: /Library/Frameworks/R.framework/Versions/4.3-arm64/Resources/lib/libRlapack.dylib;  LAPACK version 3.11.0\n\nlocale:\n[1] en_GB.UTF-8/en_GB.UTF-8/en_GB.UTF-8/C/en_GB.UTF-8/en_GB.UTF-8\n\ntime zone: Europe/London\ntzcode source: internal\n\nattached base packages:\n[1] stats     graphics  grDevices utils     datasets  methods   base     \n\nother attached packages:\n[1] dplyr_1.1.2 ivreg_0.6-2\n\nloaded via a namespace (and not attached):\n [1] vctrs_0.6.2       cli_3.6.1         knitr_1.43        rlang_1.1.1      \n [5] xfun_0.39         Formula_1.2-5     car_3.1-2         generics_0.1.3   \n [9] jsonlite_1.8.5    glue_1.6.2        zoo_1.8-12        htmltools_0.5.5  \n[13] lmtest_0.9-40     fansi_1.0.4       rmarkdown_2.22    grid_4.3.0       \n[17] tibble_3.2.1      evaluate_0.21     carData_3.0-5     abind_1.4-5      \n[21] MASS_7.3-58.4     fastmap_1.1.1     lifecycle_1.0.3   yaml_2.3.7       \n[25] compiler_4.3.0    pkgconfig_2.0.3   htmlwidgets_1.6.2 rstudioapi_0.14  \n[29] lattice_0.21-8    digest_0.6.31     R6_2.5.1          tidyselect_1.2.0 \n[33] utf8_1.2.3        pillar_1.9.0      magrittr_2.0.3    tools_4.3.0      \n```\n:::\n:::\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}