{
  "hash": "035322ba70214648d751c3a6bae9371d",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"residual-height\"\nauthor: Gibran Hemani\ndate: \"2026-02-13\"\ncategories: []\n---\n\n## Background\n\n$$\nX = \\beta_{gx} G + \\beta_{cx} C + \\epsilon_x\n$$\n\n$$\nY = \\beta_{xy} X + \\beta_{cy} C + \\epsilon_y\n$$\n\nTwo stage least squares aims to estimate the causal effect of X on Y, $\\beta_{xy}$, by using G as an instrument for X. The first stage regression is:\n\n$$\nX = \\beta_{gx} G\n$$\n\nMake a prediction of X from G, and then use this predicted value of X in the second stage regression to estimate $\\beta_{xy}$.  \n\n$$\n\\hat{X} = \\hat{\\beta}_{gx} G\n$$\n\nAnd then the second stage regression is:\n\n$$\nY = \\beta_{xy} \\hat{X} + error\n$$\n\nSo $\\hat{\\beta_{xy}}$ is the estimate of the causal effect of X on Y, which is independent of the common confounding of X and Y.\n\n## Simulation\n\nGenerate Height:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nset.seed(123)\nlibrary(dplyr)\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\n\nAttaching package: 'dplyr'\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nThe following objects are masked from 'package:stats':\n\n    filter, lag\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nThe following objects are masked from 'package:base':\n\n    intersect, setdiff, setequal, union\n```\n\n\n:::\n\n```{.r .cell-code}\nlibrary(ggplot2)\nlibrary(furrr)\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\nLoading required package: future\n```\n\n\n:::\n\n```{.r .cell-code}\nlibrary(knitr)\nn <- 1000000\nh2 <- 0.7\nr2_prs <- 0.75\nprs_explained <- rnorm(n, mean = 0, sd = sqrt(r2_prs * h2))\nprs_unexplained <- rnorm(n, mean = 0, sd = sqrt((1 - r2_prs) * h2))\nchildhood_environment <- rnorm(n, mean = 0, sd = sqrt(1 - h2))\nheight <- prs_explained + prs_unexplained + childhood_environment\nresidual_height <- height - prs_explained\n```\n:::\n\n\nGenerate coronary heart disease (just a continuous measure for simplicity):\n\n\n::: {.cell}\n\n```{.r .cell-code}\nbeta_height_chd <- -0.1\nbeta_environment_chd <- -0.2\nchd <- beta_height_chd * height + beta_environment_chd * childhood_environment + rnorm(n)\n```\n:::\n\n\nGet estimates of the effect of PRS, height and residual height on CHD:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nget_est <- function(x, y) {\n    mod <- summary(lm(y ~ x))$coefficients\n    tibble(\n        beta = mod[2, 1],\n        se = mod[2, 2],\n        p = mod[2, 4],\n        rsq = cor(x, y)^2,\n        var_exposure = var(x)\n    )\n}\nbind_rows(\n    get_est(prs_explained, chd) %>% mutate(exposure = \"PRS\"),\n    get_est(height, chd) %>% mutate(exposure = \"Height\"),\n    get_est(residual_height, chd) %>% mutate(exposure = \"Residual Height\")\n) %>% kable()\n```\n\n::: {.cell-output-display}\n\n\n|       beta|        se|  p|       rsq| var_exposure|exposure        |\n|----------:|---------:|--:|---------:|------------:|:---------------|\n| -0.1009233| 0.0014010|  0| 0.0051627|    0.5249234|PRS             |\n| -0.1614507| 0.0010052|  0| 0.0251495|    0.9992023|Height          |\n| -0.2279945| 0.0014585|  0| 0.0238522|    0.4752085|Residual Height |\n\n\n:::\n:::\n\n\nGeneralise this simulation to a function:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsim <- function(h2, r2_prs, beta_height_chd, beta_environment_chd, n = 100000, simrep = 1) {\n    args <- list(\n        h2 = h2,\n        r2_prs = r2_prs,\n        beta_height_chd = beta_height_chd,\n        beta_environment_chd = beta_environment_chd,\n        n = n,\n        simrep = simrep\n    )\n    prs_explained <- rnorm(n, mean = 0, sd = sqrt(r2_prs * h2))\n    prs_unexplained <- rnorm(n, mean = 0, sd = sqrt((1 - r2_prs) * h2))\n    childhood_environment <- rnorm(n, mean = 0, sd = sqrt(1 - h2))\n    height <- prs_explained + prs_unexplained + childhood_environment\n    residual_height <- height - prs_explained\n    chd <- beta_height_chd * height + beta_environment_chd * childhood_environment + rnorm(n)\n    res <- bind_rows(\n        get_est(prs_explained, chd) %>% mutate(exposure = \"PRS\"),\n        get_est(height, chd) %>% mutate(exposure = \"Height\"),\n        get_est(residual_height, chd) %>% mutate(exposure = \"Residual Height\")\n    )\n    bind_cols(args, res)\n}\nsim(h2 = 0.7, r2_prs = 0.75, beta_height_chd = -0.1, beta_environment_chd = -0.1) %>% kable()\n```\n\n::: {.cell-output-display}\n\n\n|  h2| r2_prs| beta_height_chd| beta_environment_chd|     n| simrep|       beta|        se|  p|       rsq| var_exposure|exposure        |\n|---:|------:|---------------:|--------------------:|-----:|------:|----------:|---------:|--:|---------:|------------:|:---------------|\n| 0.7|   0.75|            -0.1|                 -0.1| 1e+05|      1| -0.1142055| 0.0043857|  0| 0.0067356|    0.5240976|PRS             |\n| 0.7|   0.75|            -0.1|                 -0.1| 1e+05|      1| -0.1353018| 0.0031543|  0| 0.0180668|    1.0015774|Height          |\n| 0.7|   0.75|            -0.1|                 -0.1| 1e+05|      1| -0.1581388| 0.0045785|  0| 0.0117895|    0.4784431|Residual Height |\n\n\n:::\n:::\n\n\nTry a few different scenarios\n\n\n::: {.cell}\n\n```{.r .cell-code}\nparams <- expand.grid(\n    h2 = 0.7,\n    r2_prs = c(0.75, 0.4),\n    beta_height_chd = c(0, -0.1, -0.2, -0.3),\n    beta_environment_chd = c(-0.1, -0.2, -0.3),\n    simrep = 1:10\n)\n\nplan(multicore)\nresults <- future_pmap(params, sim, .progress = TRUE) %>% bind_rows() \n```\n:::\n\n\nlook at the results:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot(results, aes(x = beta_height_chd, y = beta, colour = exposure)) +\n    geom_point() +\n    facet_grid(r2_prs ~ beta_environment_chd, labeller = label_both) +\n    scale_colour_brewer(type=\"qual\")\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-6-1.png){width=672}\n:::\n:::\n\n\n\n---\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsessionInfo()\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nR version 4.5.2 (2025-10-31)\nPlatform: aarch64-apple-darwin20\nRunning under: macOS Sequoia 15.2\n\nMatrix products: default\nBLAS:   /System/Library/Frameworks/Accelerate.framework/Versions/A/Frameworks/vecLib.framework/Versions/A/libBLAS.dylib \nLAPACK: /Library/Frameworks/R.framework/Versions/4.5-arm64/Resources/lib/libRlapack.dylib;  LAPACK version 3.12.1\n\nlocale:\n[1] en_US.UTF-8/en_US.UTF-8/en_US.UTF-8/C/en_US.UTF-8/en_US.UTF-8\n\ntime zone: Europe/London\ntzcode source: internal\n\nattached base packages:\n[1] stats     graphics  grDevices utils     datasets  methods   base     \n\nother attached packages:\n[1] knitr_1.50    furrr_0.3.1   future_1.69.0 ggplot2_4.0.1 dplyr_1.1.4  \n\nloaded via a namespace (and not attached):\n [1] gtable_0.3.6       jsonlite_2.0.0     compiler_4.5.2     tidyselect_1.2.1  \n [5] parallel_4.5.2     globals_0.19.0     scales_1.4.0       yaml_2.3.11       \n [9] fastmap_1.2.0      R6_2.6.1           labeling_0.4.3     generics_0.1.4    \n[13] htmlwidgets_1.6.4  tibble_3.3.0       pillar_1.11.1      RColorBrewer_1.1-3\n[17] rlang_1.1.6        xfun_0.54          S7_0.2.1           cli_3.6.5         \n[21] withr_3.0.2        magrittr_2.0.4     digest_0.6.39      grid_4.5.2        \n[25] lifecycle_1.0.4    vctrs_0.6.5        evaluate_1.0.5     glue_1.8.0        \n[29] farver_2.1.2       listenv_0.10.0     codetools_0.2-20   parallelly_1.46.1 \n[33] rmarkdown_2.30     purrr_1.2.0        tools_4.5.2        pkgconfig_2.0.3   \n[37] htmltools_0.5.8.1 \n```\n\n\n:::\n:::\n\n",
    "supporting": [
      "index_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}