{
  "hash": "3e9fb597b392ad656969bea17bc324de",
  "result": {
    "markdown": "---\ntitle: \"Power of sibling estimate of for rare variants\"\nauthor: Gibran Hemani\ndate: \"2023-11-10\"\ncategories: []\n---\n\n\n## Background\n\nAscertaining families who have rare disease can improve power of detection because rare variant is segregating within the family. What about rare variants influencing trait where families are not ascertained?\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(dplyr)\n```\n\n::: {.cell-output .cell-output-stderr}\n```\n\nAttaching package: 'dplyr'\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\nThe following objects are masked from 'package:stats':\n\n    filter, lag\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\nThe following objects are masked from 'package:base':\n\n    intersect, setdiff, setequal, union\n```\n:::\n\n```{.r .cell-code}\nmake_families <- function(af, nfam) {\n\tnsnp <- length(af)\n\tdads <- matrix(0, nfam, nsnp)\n\tmums <- matrix(0, nfam, nsnp)\n\tsibs1 <- matrix(0, nfam, nsnp)\n\tsibs2 <- matrix(0, nfam, nsnp)\n\tibd <- matrix(0, nfam, nsnp)\n\tibs <- matrix(0, nfam, nsnp)\n\tfor(i in 1:nsnp)\n\t{\n\t\tdad1 <- rbinom(nfam, 1, af[i]) + 1\n\t\tdad2 <- (rbinom(nfam, 1, af[i]) + 1) * -1\n\t\tmum1 <- rbinom(nfam, 1, af[i]) + 1\n\t\tmum2 <- (rbinom(nfam, 1, af[i]) + 1) * -1\n\n\t\tdadindex <- sample(c(TRUE, FALSE), nfam, replace=TRUE)\n\t\tdadh <- rep(NA, nfam)\n\t\tdadh[dadindex] <- dad1[dadindex]\n\t\tdadh[!dadindex] <- dad2[!dadindex]\n\n\t\tmumindex <- sample(c(TRUE, FALSE), nfam, replace=TRUE)\n\t\tmumh <- rep(NA, nfam)\n\t\tmumh[mumindex] <- mum1[mumindex]\n\t\tmumh[!mumindex] <- mum2[!mumindex]\n\n\t\tsib1 <- cbind(dadh, mumh)\n\n\t\tdadindex <- sample(c(TRUE, FALSE), nfam, replace=TRUE)\n\t\tdadh <- rep(NA, nfam)\n\t\tdadh[dadindex] <- dad1[dadindex]\n\t\tdadh[!dadindex] <- dad2[!dadindex]\n\n\t\tmumindex <- sample(c(TRUE, FALSE), nfam, replace=TRUE)\n\t\tmumh <- rep(NA, nfam)\n\t\tmumh[mumindex] <- mum1[mumindex]\n\t\tmumh[!mumindex] <- mum2[!mumindex]\n\n\t\tsib2 <- cbind(dadh, mumh)\n\n\t\tibd[,i] <- (as.numeric(sib1[,1] == sib2[,1]) + as.numeric(sib1[,2] == sib2[,2])) / 2\n\n\n\t\tsibs1[,i] <- rowSums(abs(sib1) - 1)\n\t\tsibs2[,i] <- rowSums(abs(sib2) - 1)\n\t\tdads[,i] <- dad1 - 1 + abs(dad2) - 1\n\t\tmums[,i] <- mum1 - 1 + abs(mum2) - 1\n\n\t\t# l[[i]] <- (sum(sib1[,1] == sib2[,1]) / nsnp + sum(sib1[,2] == sib2[,2]) / nsnp) / 2\n\n\t}\n\n\t# This may not be correct - getting some really large values\n\tibs <- scale(sibs1) * scale(sibs2)\n\n\t# Just count how many alleles are in common\n\tibs_unw <- abs(abs(sibs1 - sibs2) - 2) / 2\n\treturn(list(dads=dads, mums=mums, sibs1=sibs1, sibs2=sibs2, ibd=ibd, ibs=ibs, ibs_unw=ibs_unw))\n}\n\nmakePhen <- function(effs, indep, vy=1, vx=rep(1, length(effs)), my=0) {\n\tif(is.null(dim(indep))) indep <- cbind(indep)\n\tstopifnot(ncol(indep) == length(effs))\n\tstopifnot(length(vx) == length(effs))\n\tcors <- effs * vx / sqrt(vx) / sqrt(vy)\n\tstopifnot(sum(cors^2) <= 1)\n\tcors <- c(cors, sqrt(1-sum(cors^2)))\n\tindep <- t(t(scale(cbind(indep, rnorm(nrow(indep))))) * cors * c(vx, 1))\n\ty <- drop(scale(rowSums(indep)) * sqrt(vy)) + my\n\treturn(y)\n}\n\nchooseEffects <- function(nsnp, totvar, sqrt=TRUE) {\n\teff <- rnorm(nsnp)\n\taeff <- abs(eff)\n\tsc <- sum(aeff) / totvar\n\tout <- eff / sc\n\tif(sqrt)\n\t{\n\t\tout <- sqrt(abs(out)) * sign(out)\n\t}\n\treturn(out)\n}\n\nmake_phenotypes <- function(fam, eff_gx, eff_xy, vx, vy, mx, my) {\n\tlapply(fam, function(g)\n\t{\n\t\tu <- rnorm(nrow(g))\n\t\tx <- makePhen(c(eff_gx), cbind(g), vy=vx, my=mx)\n\t\ty <- makePhen(c(eff_xy), cbind(x), vy=vy, my=my)\n\t\treturn(data.frame(x=x, y=y))\n\t})\n}\n\njoin_populations <- function(l) {\n\tdads <- do.call(rbind, lapply(l, function(x) x$dads))\n\tmums <- do.call(rbind, lapply(l, function(x) x$mums))\n\tsibs1 <- do.call(rbind, lapply(l, function(x) x$sibs1))\n\tsibs2 <- do.call(rbind, lapply(l, function(x) x$sibs2))\n\tibd <- do.call(rbind, lapply(l, function(x) x$ibd))\n\tibs <- do.call(rbind, lapply(l, function(x) x$ibs))\n\treturn(list(dads=dads, mums=mums, sibs1=sibs1, sibs2=sibs2, ibd=ibd, ibs=ibs))\n}\n\nsample_populations <- function(l, n) {\n\tx <- nrow(l$dads)\n\tindex <- sort(sample(1:x, n, replace=FALSE))\n\tl$dads <- l$dads[index,]\n\tl$mums <- l$mums[index,]\n\tl$sibs1 <- l$sibs1[index,]\n\tl$sibs2 <- l$sibs2[index,]\n\tl$ibd <- l$ibd[index,]\n\tl$ibs <- l$ibs[index,]\n\tl$ibs_unw <- l$ibs_unw[index,]\n\treturn(l)\n}\n\nmakephen <- function(b, g, vx=1) {\n    pred <- b * g\n    e <- rnorm(length(g), 0, sqrt(1-var(pred)))\n    return(pred+e)\n}\n\n# Dynastic effects\ndynastic_phen <- function(fam, eff_gx, eff_xy, eff_ux, eff_uy, eff_xu) {\n\tn <- nrow(fam$sibs1)\n\t\n\t# parents x\n\n\t# umums <- rnorm(n)\n\t# udads <- rnorm(n)\n\t# xmums <- makePhen(c(eff_gx, eff_ux), cbind(fam$mums, umums))\n\t# xdads <- makePhen(c(eff_gx, eff_ux), cbind(fam$dads, udads))\n\n\tx1 <- makephen(eff_gx, fam$sibs1)\n    x2 <- makephen(eff_gx, fam$sibs2)\n\tl <- list()\n\t# l$dads <- data.frame(x=xdads)\n\t# l$mums <- data.frame(x=xmums)\n\tl$sibs1 <- data.frame(x=x1)\n\tl$sibs2 <- data.frame(x=x2)\n\treturn(l)\n}\n\nsibreg <- function(g1, g2, y1, y2) {\n    d <- bind_rows(\n        tibble(\n            y=y1, fg=(g1+g2)/2, cg=g1-fg\n        ),\n        tibble(\n            y=y2, fg=(g1+g2)/2, cg=g2-fg\n        )\n    )\n    m <- summary(lm(y ~ cg + fg, data=d))$coef\n    tibble(bhat=m[2,1], se=m[2,2], pval=m[2,4], n=nrow(d), method=\"sibreg\")\n}\n\npopreg <- function(y, x) {\n\tindex <- is.finite(y) & is.finite(x)\n\tn <- sum(index)\n\ty <- y[index]\n\tx <- x[index]\n\tvx <- var(x)\n\tbhat <- cov(y, x) / vx\n\tahat <- mean(y) - bhat * mean(x)\n\t# fitted <- ahat + x * bhat\n\t# residuals <- y - fitted\n\t# SSR <- sum((residuals - mean(residuals))^2)\n\t# SSF <- sum((fitted - mean(fitted))^2)\n\n\trsq <- (bhat * vx)^2 / (vx * var(y))\n\tfval <- rsq * (n-2) / (1-rsq)\n\ttval <- sqrt(fval)\n\tse <- abs(bhat / tval)\n\n\t# Fval <- (SSF) / (SSR/(n-2))\n\t# pval <- pf(Fval, 1, n-2, lowe=F)\n\tp <- pf(fval, 1, n-2, lowe=F)\n\treturn(tibble(\n\t\tbhat=bhat, se=se, fval=fval, pval=p, n=n, method=\"popreg\"\n\t))\n}\n\nsibreg2 <- function(fam, phen) {\n    sdiffgx <- fam$sibs1[,1] - fam$sibs2[,1]\n    sdiffx <- phen$sibs1$x - phen$sibs2$x\n    popreg(sdiffx, sdiffgx) %>% mutate(method=\"sibreg\")\n}\n\nreg <- function(f, p) {\n    # sibreg(f$sibs1[,1], f$sibs2[,1], p$sibs1$x, p$sibs2$x)\n    bind_rows(\n        sibreg2(f, p),\n        popreg(p$sibs1[,1], f$sibs1[,1])\n    )\n}\n\n\nr2 <- 0.001\nparam <- tibble(\n    af=seq(0.0001, 0.01, by=0.00005),\n    vg=r2,\n    varg=2*af*(1-af),\n    b=sqrt(r2/varg)\n)\n\nres <- lapply(1:nrow(param), \\(i) {\n    f <- make_families(param$af[i], 500000)\n    p <- dynastic_phen(f, param$b[i], 0, 0, 0, 0)\n    r <- reg(f, p)\n    r$af=param$af[i]\n    return(r)\n}) %>% bind_rows()\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(ggplot2)\nres %>% group_by(af) %>%\n    summarise(fvalratio=fval[1]/fval[2]) %>%\nggplot(., aes(x=af, y=fvalratio)) +\ngeom_point()\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-2-1.png){width=672}\n:::\n:::\n\n\n\n## Summary\n\n- Power ratio does not change by allele frequency\n\n---\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsessionInfo()\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nR version 4.3.2 (2023-10-31)\nPlatform: aarch64-apple-darwin20 (64-bit)\nRunning under: macOS Ventura 13.6\n\nMatrix products: default\nBLAS:   /Library/Frameworks/R.framework/Versions/4.3-arm64/Resources/lib/libRblas.0.dylib \nLAPACK: /Library/Frameworks/R.framework/Versions/4.3-arm64/Resources/lib/libRlapack.dylib;  LAPACK version 3.11.0\n\nlocale:\n[1] en_GB.UTF-8/en_GB.UTF-8/en_GB.UTF-8/C/en_GB.UTF-8/en_GB.UTF-8\n\ntime zone: Europe/London\ntzcode source: internal\n\nattached base packages:\n[1] stats     graphics  grDevices utils     datasets  methods   base     \n\nother attached packages:\n[1] ggplot2_3.4.2 dplyr_1.1.4  \n\nloaded via a namespace (and not attached):\n [1] vctrs_0.6.4       cli_3.6.1         knitr_1.45        rlang_1.1.2      \n [5] xfun_0.41         generics_0.1.3    jsonlite_1.8.7    labeling_0.4.2   \n [9] glue_1.6.2        colorspace_2.1-0  htmltools_0.5.7   scales_1.2.1     \n[13] fansi_1.0.5       rmarkdown_2.25    grid_4.3.2        munsell_0.5.0    \n[17] evaluate_0.23     tibble_3.2.1      fastmap_1.1.1     yaml_2.3.7       \n[21] lifecycle_1.0.4   compiler_4.3.2    htmlwidgets_1.6.3 pkgconfig_2.0.3  \n[25] farver_2.1.1      digest_0.6.33     R6_2.5.1          tidyselect_1.2.0 \n[29] utf8_1.2.4        pillar_1.9.0      magrittr_2.0.3    withr_2.5.2      \n[33] tools_4.3.2       gtable_0.3.3     \n```\n:::\n:::\n",
    "supporting": [
      "index_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}